# Prometheus Alert Rules - Container & Kubernetes Monitoring

groups:
  - name: containers
    interval: 30s
    rules:
      # Container resource alerts
      - alert: ContainerHighCPU
        expr: sum(rate(container_cpu_usage_seconds_total{name!=""}[5m])) by (name, instance) * 100 > 80
        for: 5m
        labels:
          severity: warning
          category: infrastructure
        annotations:
          summary: "Container {{ $labels.name }} high CPU usage"
          description: "Container CPU usage is above 80% (current value: {{ $value }}%)"

      - alert: ContainerHighMemory
        expr: sum(container_memory_usage_bytes{name!=""}) by (name, instance) / sum(container_spec_memory_limit_bytes{name!=""}) by (name, instance) * 100 > 80
        for: 5m
        labels:
          severity: warning
          category: infrastructure
        annotations:
          summary: "Container {{ $labels.name }} high memory usage"
          description: "Container memory usage is above 80% of limit (current value: {{ $value }}%)"

      - alert: ContainerRestarting
        expr: rate(container_restarts_total{name!=""}[15m]) > 0
        for: 5m
        labels:
          severity: warning
          category: infrastructure
        annotations:
          summary: "Container {{ $labels.name }} is restarting"
          description: "Container has restarted {{ $value }} times in the last 15 minutes"

      - alert: ContainerDown
        expr: time() - container_last_seen{name!=""} > 60
        for: 1m
        labels:
          severity: critical
          category: infrastructure
        annotations:
          summary: "Container {{ $labels.name }} is down"
          description: "Container has not been seen for more than 1 minute"

  # Kubernetes-specific alerts
  - name: kubernetes
    interval: 30s
    rules:
      - alert: PodCrashLooping
        expr: rate(kube_pod_container_status_restarts_total[15m]) > 0
        for: 5m
        labels:
          severity: critical
          category: infrastructure
        annotations:
          summary: "Pod {{ $labels.namespace }}/{{ $labels.pod }} is crash looping"
          description: "Pod has restarted {{ $value }} times in the last 15 minutes"

      - alert: PodNotReady
        expr: kube_pod_status_phase{phase!~"Running|Succeeded"} > 0
        for: 10m
        labels:
          severity: warning
          category: infrastructure
        annotations:
          summary: "Pod {{ $labels.namespace }}/{{ $labels.pod }} not ready"
          description: "Pod has been in {{ $labels.phase }} state for more than 10 minutes"

      - alert: DeploymentReplicasMismatch
        expr: kube_deployment_spec_replicas != kube_deployment_status_replicas_available
        for: 10m
        labels:
          severity: warning
          category: infrastructure
        annotations:
          summary: "Deployment {{ $labels.namespace }}/{{ $labels.deployment }} replicas mismatch"
          description: "Desired replicas ({{ $labels.spec_replicas }}) != available replicas"

      - alert: StatefulSetReplicasMismatch
        expr: kube_statefulset_status_replicas_ready != kube_statefulset_status_replicas
        for: 10m
        labels:
          severity: warning
          category: infrastructure
        annotations:
          summary: "StatefulSet {{ $labels.namespace }}/{{ $labels.statefulset }} replicas mismatch"
          description: "Not all replicas are ready"

      - alert: PersistentVolumeClaimPending
        expr: kube_persistentvolumeclaim_status_phase{phase="Pending"} > 0
        for: 10m
        labels:
          severity: warning
          category: infrastructure
        annotations:
          summary: "PVC {{ $labels.namespace }}/{{ $labels.persistentvolumeclaim }} is pending"
          description: "PersistentVolumeClaim has been pending for more than 10 minutes"

      - alert: NodeNotReady
        expr: kube_node_status_condition{condition="Ready",status="true"} == 0
        for: 5m
        labels:
          severity: critical
          category: infrastructure
        annotations:
          summary: "Node {{ $labels.node }} not ready"
          description: "Node has been in NotReady state for more than 5 minutes"

      - alert: NodeMemoryPressure
        expr: kube_node_status_condition{condition="MemoryPressure",status="true"} == 1
        for: 5m
        labels:
          severity: warning
          category: infrastructure
        annotations:
          summary: "Node {{ $labels.node }} under memory pressure"
          description: "Node is experiencing memory pressure"

      - alert: NodeDiskPressure
        expr: kube_node_status_condition{condition="DiskPressure",status="true"} == 1
        for: 5m
        labels:
          severity: warning
          category: infrastructure
        annotations:
          summary: "Node {{ $labels.node }} under disk pressure"
          description: "Node is experiencing disk pressure"

      - alert: TooManyPods
        expr: kubelet_running_pod_count > 100
        for: 10m
        labels:
          severity: warning
          category: infrastructure
        annotations:
          summary: "Too many pods on node {{ $labels.node }}"
          description: "Node is running {{ $value }} pods (threshold: 100)"
