# Prometheus Alert Rules - Database Monitoring

groups:
  - name: postgresql
    interval: 30s
    rules:
      - alert: PostgreSQLDown
        expr: pg_up == 0
        for: 1m
        labels:
          severity: critical
          category: database
        annotations:
          summary: "PostgreSQL instance {{ $labels.instance }} is down"
          description: "PostgreSQL database is not responding"

      - alert: PostgreSQLTooManyConnections
        expr: sum by (instance) (pg_stat_activity_count) > (pg_settings_max_connections * 0.8)
        for: 5m
        labels:
          severity: warning
          category: database
        annotations:
          summary: "PostgreSQL {{ $labels.instance }} has too many connections"
          description: "Connection count ({{ $value }}) is above 80% of max_connections"

      - alert: PostgreSQLSlowQueries
        expr: avg by (instance) (rate(pg_stat_activity_max_tx_duration[5m])) > 60
        for: 10m
        labels:
          severity: warning
          category: database
        annotations:
          summary: "PostgreSQL {{ $labels.instance }} has slow queries"
          description: "Average query duration is above 60 seconds"

      - alert: PostgreSQLHighRollbackRate
        expr: rate(pg_stat_database_xact_rollback[5m]) / rate(pg_stat_database_xact_commit[5m]) > 0.1
        for: 10m
        labels:
          severity: warning
          category: database
        annotations:
          summary: "PostgreSQL {{ $labels.instance }} high rollback rate"
          description: "Rollback rate is above 10% (current: {{ $value }}%)"

      - alert: PostgreSQLDeadlocks
        expr: rate(pg_stat_database_deadlocks[5m]) > 0
        for: 5m
        labels:
          severity: warning
          category: database
        annotations:
          summary: "PostgreSQL {{ $labels.instance }} experiencing deadlocks"
          description: "Database has {{ $value }} deadlocks per second"

      - alert: PostgreSQLReplicationLag
        expr: pg_replication_lag > 30
        for: 5m
        labels:
          severity: warning
          category: database
        annotations:
          summary: "PostgreSQL replication lag on {{ $labels.instance }}"
          description: "Replication is lagging by {{ $value }} seconds"

  - name: mysql
    interval: 30s
    rules:
      - alert: MySQLDown
        expr: mysql_up == 0
        for: 1m
        labels:
          severity: critical
          category: database
        annotations:
          summary: "MySQL instance {{ $labels.instance }} is down"
          description: "MySQL database is not responding"

      - alert: MySQLTooManyConnections
        expr: mysql_global_status_threads_connected / mysql_global_variables_max_connections * 100 > 80
        for: 5m
        labels:
          severity: warning
          category: database
        annotations:
          summary: "MySQL {{ $labels.instance }} has too many connections"
          description: "Connection usage is above 80% (current: {{ $value }}%)"

      - alert: MySQLSlowQueries
        expr: rate(mysql_global_status_slow_queries[5m]) > 0.05
        for: 10m
        labels:
          severity: warning
          category: database
        annotations:
          summary: "MySQL {{ $labels.instance }} has slow queries"
          description: "Slow query rate is {{ $value }} queries/second"

      - alert: MySQLReplicationStopped
        expr: mysql_slave_status_slave_io_running == 0 or mysql_slave_status_slave_sql_running == 0
        for: 1m
        labels:
          severity: critical
          category: database
        annotations:
          summary: "MySQL replication stopped on {{ $labels.instance }}"
          description: "Replication is not running"

      - alert: MySQLReplicationLag
        expr: mysql_slave_status_seconds_behind_master > 30
        for: 5m
        labels:
          severity: warning
          category: database
        annotations:
          summary: "MySQL replication lag on {{ $labels.instance }}"
          description: "Replication is lagging by {{ $value }} seconds"

  - name: mongodb
    interval: 30s
    rules:
      - alert: MongoDBDown
        expr: mongodb_up == 0
        for: 1m
        labels:
          severity: critical
          category: database
        annotations:
          summary: "MongoDB instance {{ $labels.instance }} is down"
          description: "MongoDB database is not responding"

      - alert: MongoDBTooManyConnections
        expr: mongodb_connections{state="current"} / mongodb_connections{state="available"} * 100 > 80
        for: 5m
        labels:
          severity: warning
          category: database
        annotations:
          summary: "MongoDB {{ $labels.instance }} has too many connections"
          description: "Connection usage is above 80% (current: {{ $value }}%)"

      - alert: MongoDBReplicationLag
        expr: mongodb_replset_member_replication_lag > 10
        for: 5m
        labels:
          severity: warning
          category: database
        annotations:
          summary: "MongoDB replication lag on {{ $labels.instance }}"
          description: "Replication is lagging by {{ $value }} seconds"

      - alert: MongoDBReplicationHeadroom
        expr: (mongodb_replset_oplog_head_timestamp - mongodb_replset_oplog_tail_timestamp) < 3600
        for: 10m
        labels:
          severity: warning
          category: database
        annotations:
          summary: "MongoDB {{ $labels.instance }} low oplog headroom"
          description: "Oplog headroom is less than 1 hour"

  - name: redis
    interval: 30s
    rules:
      - alert: RedisDown
        expr: redis_up == 0
        for: 1m
        labels:
          severity: critical
          category: database
        annotations:
          summary: "Redis instance {{ $labels.instance }} is down"
          description: "Redis is not responding"

      - alert: RedisOutOfMemory
        expr: redis_memory_used_bytes / redis_memory_max_bytes * 100 > 90
        for: 5m
        labels:
          severity: warning
          category: database
        annotations:
          summary: "Redis {{ $labels.instance }} running out of memory"
          description: "Memory usage is above 90% (current: {{ $value }}%)"

      - alert: RedisTooManyConnections
        expr: redis_connected_clients > 100
        for: 5m
        labels:
          severity: warning
          category: database
        annotations:
          summary: "Redis {{ $labels.instance }} has too many connections"
          description: "Connected clients: {{ $value }} (threshold: 100)"

      - alert: RedisRejectedConnections
        expr: rate(redis_rejected_connections_total[5m]) > 0
        for: 5m
        labels:
          severity: warning
          category: database
        annotations:
          summary: "Redis {{ $labels.instance }} rejecting connections"
          description: "Redis is rejecting {{ $value }} connections/second due to maxclients limit"

      - alert: RedisHighFragmentation
        expr: redis_mem_fragmentation_ratio > 1.5
        for: 10m
        labels:
          severity: warning
          category: database
        annotations:
          summary: "Redis {{ $labels.instance }} high memory fragmentation"
          description: "Memory fragmentation ratio is {{ $value }}"

      - alert: RedisReplicationBroken
        expr: redis_connected_slaves < 1
        for: 5m
        labels:
          severity: critical
          category: database
        annotations:
          summary: "Redis {{ $labels.instance }} has no connected slaves"
          description: "Master has no connected slaves for replication"
